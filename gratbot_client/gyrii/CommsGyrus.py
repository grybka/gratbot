
from Gyrus import ThreadedGyrus
from GratbotCommsMk2 import GratbotCommsMk2
import numpy as np
import logging
import time
from gyrii.underpinnings.GratbotLogger import gprint
sim_lidar_scan=[[15, 351.9375, 1864.25], [15, 353.265625, 1895.0], [15, 354.640625, 1981.25], [15, 356.015625, 1987.75], [15, 357.453125, 1903.5], [15, 358.8125, 1851.25], [15, 0.140625, 1998.75], [15, 1.28125, 2094.0], [15, 2.65625, 2128.0], [15, 3.9375, 2422.25], [15, 5.296875, 2447.25], [15, 6.625, 2688.5], [15, 8.03125, 2736.75], [15, 9.375, 2745.5], [15, 10.765625, 2758.25], [15, 12.140625, 2791.5], [15, 13.5, 2812.25], [15, 14.890625, 2820.25], [15, 16.25, 2836.75], [15, 17.640625, 2869.25], [15, 19.03125, 2903.5], [15, 20.40625, 2865.75], [15, 21.78125, 2785.0], [15, 23.203125, 2669.25], [15, 24.59375, 2643.0], [14, 25.9375, 2701.25], [15, 27.25, 3077.0], [15, 28.609375, 3178.75], [15, 30.0, 3208.75], [15, 31.375, 3270.5], [15, 32.75, 3336.75], [15, 34.125, 3344.0], [15, 35.5, 3306.5], [15, 36.921875, 3155.5], [15, 38.28125, 3182.5], [15, 39.640625, 3230.75], [13, 41.03125, 3208.5], [12, 42.40625, 3189.0], [11, 43.8125, 3161.25], [11, 45.171875, 3165.75], [13, 46.578125, 3117.5], [15, 49.328125, 3114.0], [15, 50.703125, 3091.0], [12, 52.09375, 3100.25], [12, 53.46875, 3098.5], [10, 54.84375, 3077.0], [13, 56.234375, 3080.5], [13, 57.625, 3091.5], [14, 58.984375, 3100.75], [14, 60.359375, 3134.75], [15, 61.765625, 3120.0], [15, 63.140625, 3120.75], [15, 64.484375, 3104.75], [15, 65.890625, 3112.0], [15, 67.265625, 3113.25], [15, 68.65625, 3121.0], [15, 70.015625, 3112.25], [15, 71.4375, 3069.0], [15, 72.796875, 3032.25], [15, 74.203125, 3025.0], [15, 75.5625, 3015.5], [15, 76.953125, 2998.25], [15, 78.3125, 2971.75], [15, 79.71875, 2988.75], [15, 81.109375, 2947.25], [15, 82.484375, 2959.0], [15, 83.859375, 2932.5], [15, 85.25, 2928.75], [15, 86.625, 2949.25], [15, 88.03125, 2946.5], [15, 89.390625, 2931.5], [15, 90.75, 2936.25], [15, 92.15625, 2940.25], [15, 93.515625, 2957.5], [15, 94.90625, 2988.0], [15, 96.28125, 2990.5], [15, 97.65625, 3001.0], [15, 99.046875, 3011.75], [15, 100.421875, 3021.25], [15, 101.78125, 3043.25], [15, 103.171875, 3055.5], [15, 104.53125, 3095.5], [15, 105.921875, 3117.5], [15, 107.28125, 3042.25], [15, 108.671875, 2940.25], [15, 110.09375, 2782.75], [15, 111.46875, 2620.5], [15, 112.921875, 2480.0], [15, 114.3125, 2366.25], [15, 115.703125, 2261.0], [15, 117.125, 2163.5], [15, 118.515625, 2070.0], [15, 120.140625, 1989.75], [15, 121.546875, 1889.0], [15, 123.0, 1815.5], [15, 124.359375, 1792.0], [15, 125.765625, 1732.5], [15, 127.203125, 1678.0], [15, 128.5625, 1636.0], [15, 129.984375, 1585.25], [15, 131.34375, 1549.25], [15, 132.6875, 1511.0], [15, 134.125, 1477.0], [15, 135.484375, 1434.75], [15, 136.9375, 1410.5], [15, 138.265625, 1378.25], [15, 139.65625, 1355.75], [15, 141.125, 1328.0], [15, 142.515625, 1308.25], [15, 143.90625, 1284.25], [15, 145.28125, 1263.25], [15, 146.6875, 1246.0], [15, 148.09375, 1225.25], [15, 149.5, 1210.0], [15, 150.796875, 1181.75], [15, 152.234375, 1165.0], [15, 153.65625, 1149.5], [15, 155.078125, 1136.5], [15, 156.40625, 1145.0], [15, 157.828125, 1136.75], [15, 159.1875, 1125.0], [15, 160.609375, 1121.25], [15, 161.953125, 1124.0], [15, 163.359375, 1115.5], [15, 164.734375, 1105.75], [15, 166.140625, 1102.0], [15, 167.5, 1098.0], [15, 168.9375, 1090.25], [15, 170.28125, 1086.75], [15, 171.703125, 1083.75], [15, 173.015625, 1081.75], [15, 174.421875, 1081.25], [15, 175.765625, 1079.0], [15, 177.1875, 1079.25], [15, 178.5, 1078.75], [15, 180.0, 1078.75], [15, 181.3125, 1070.5], [15, 182.703125, 1071.5], [15, 184.125, 1073.25], [15, 185.40625, 1075.25], [15, 186.796875, 1082.75], [15, 188.1875, 1086.75], [15, 189.5625, 1092.25], [15, 190.90625, 1101.5], [15, 192.96875, 732.25], [15, 194.375, 738.5], [15, 195.71875, 747.25], [15, 197.09375, 757.5], [15, 198.453125, 771.25], [15, 199.6875, 785.5], [15, 201.03125, 813.75], [15, 202.453125, 829.5], [15, 203.703125, 847.0], [15, 205.140625, 862.5], [15, 206.375, 883.75], [15, 207.78125, 902.5], [15, 209.03125, 929.75], [15, 210.40625, 947.25], [15, 211.75, 972.5], [15, 213.15625, 1001.25], [15, 214.453125, 1033.75], [15, 215.734375, 1062.5], [15, 217.0625, 1098.5], [15, 218.484375, 1136.5], [15, 219.78125, 1176.25], [15, 221.09375, 1201.5], [15, 222.46875, 1247.5], [15, 223.71875, 1338.5], [15, 225.09375, 1390.5], [15, 228.390625, 3445.25], [15, 229.75, 3678.25], [15, 231.09375, 4058.0], [15, 232.46875, 4084.25], [15, 233.859375, 4044.25], [15, 235.234375, 4008.0], [15, 236.625, 3987.25], [15, 237.984375, 3977.25], [15, 239.359375, 3959.25], [15, 240.734375, 3953.5], [15, 242.125, 3993.75], [15, 243.5, 3926.0], [15, 244.875, 3844.25], [15, 246.28125, 3814.25], [15, 247.65625, 3792.75], [15, 249.046875, 3750.25], [15, 250.453125, 3723.0], [15, 251.828125, 3692.25], [15, 253.203125, 3689.75], [15, 254.546875, 4038.25], [15, 257.34375, 940.5], [15, 258.734375, 930.75], [15, 260.078125, 927.0], [15, 261.578125, 920.5], [15, 262.828125, 927.5], [15, 264.265625, 937.0], [15, 265.609375, 936.0], [15, 267.046875, 935.25], [15, 268.34375, 935.0], [15, 269.828125, 935.5], [15, 271.203125, 936.25], [15, 272.578125, 938.25], [15, 273.859375, 942.0], [15, 275.28125, 943.5], [15, 276.625, 946.25], [15, 277.984375, 949.0], [15, 279.328125, 956.5], [15, 280.734375, 961.75], [15, 282.015625, 965.0], [15, 283.40625, 969.5], [15, 284.75, 976.0], [15, 286.140625, 989.25], [15, 287.453125, 999.75], [15, 288.90625, 1005.25], [15, 290.203125, 1018.25], [15, 291.578125, 1026.75], [15, 292.953125, 1037.5], [15, 294.28125, 1050.5], [15, 295.6875, 1058.75], [15, 296.984375, 1075.25], [15, 298.375, 1090.0], [15, 299.796875, 1110.25], [15, 301.171875, 1128.0], [15, 302.46875, 1143.25], [15, 303.890625, 1162.5], [15, 305.171875, 1185.5], [15, 306.59375, 1211.25], [15, 307.859375, 1231.0], [15, 309.265625, 1256.75], [15, 310.625, 1286.75], [15, 312.0, 1320.75], [15, 313.328125, 1346.75], [15, 314.671875, 1381.5], [15, 316.03125, 1420.25], [15, 317.3125, 1470.25], [15, 318.6875, 1509.25], [15, 320.03125, 1552.25], [15, 321.421875, 1605.25], [15, 322.75, 1668.75], [15, 324.1875, 1712.5], [15, 325.515625, 1786.25], [15, 326.859375, 1858.25], [15, 328.203125, 1937.25], [15, 329.546875, 2030.0], [15, 330.6875, 2126.25], [15, 332.046875, 2227.75], [15, 333.375, 2360.0], [15, 334.703125, 2501.0], [15, 336.15625, 2263.5], [15, 337.53125, 2227.0], [15, 338.921875, 2217.75], [15, 340.296875, 2212.0], [15, 341.671875, 2327.0], [15, 342.984375, 2593.75], [15, 344.390625, 2501.5], [15, 345.734375, 2611.5], [15, 347.078125, 2729.25], [15, 348.453125, 2725.0], [15, 350.0, 2066.75]]
#sim_lidar_scan=[[15, 350.625, 5507.5], [15, 352.046875, 5157.0], [15, 353.421875, 5011.25], [15, 355.109375, 2526.5], [15, 356.5, 2524.5], [15, 357.890625, 2494.5], [15, 359.265625, 2479.0], [15, 0.640625, 2446.25], [15, 2.0625, 2440.25], [15, 3.453125, 2431.0], [15, 4.84375, 2414.0], [15, 6.234375, 2393.75], [15, 7.625, 2382.5], [15, 9.0, 2379.25], [15, 10.421875, 2379.25], [15, 11.78125, 2370.75], [15, 13.140625, 2369.5], [15, 14.546875, 2365.25], [15, 15.90625, 2369.0], [15, 17.3125, 2367.75], [15, 18.703125, 2368.25], [15, 20.09375, 2373.75], [15, 21.453125, 2374.75], [15, 22.84375, 2380.75], [15, 24.25, 2386.75], [15, 25.609375, 2398.75], [15, 26.984375, 2413.5], [15, 28.421875, 2417.75], [15, 29.796875, 2429.25], [15, 31.140625, 2454.0], [15, 32.546875, 2475.5], [15, 33.9375, 2491.25], [15, 35.359375, 2502.75], [15, 36.765625, 2546.75], [15, 38.09375, 2565.75], [15, 39.515625, 2577.75], [15, 40.890625, 2628.75], [15, 42.28125, 2641.75], [15, 43.640625, 2688.5], [15, 45.015625, 2719.75], [15, 46.90625, 1753.75], [15, 50.65625, 2454.5], [15, 52.03125, 2494.0], [15, 53.421875, 2558.75], [15, 55.21875, 1946.0], [15, 56.203125, 2548.0], [15, 58.078125, 1711.25], [15, 61.71875, 2724.25], [15, 63.140625, 2657.5], [15, 64.9375, 1982.5], [15, 65.921875, 2513.75], [15, 67.3125, 2484.25], [15, 68.75, 2441.5], [15, 70.140625, 2394.5], [15, 71.5625, 2348.0], [15, 72.9375, 2330.0], [15, 74.328125, 2287.5], [15, 75.71875, 2246.25], [15, 77.109375, 2198.5], [15, 78.546875, 2183.25], [15, 79.96875, 2142.5], [15, 81.3125, 2129.5], [15, 82.6875, 2113.75], [15, 84.109375, 2080.25], [15, 85.515625, 2067.5], [15, 87.140625, 2041.25], [15, 88.5, 2023.25], [15, 89.90625, 2006.25], [15, 91.28125, 1999.5], [15, 92.6875, 1992.25], [15, 94.09375, 1976.5], [15, 95.484375, 1978.5], [15, 97.015625, 1653.25], [15, 98.484375, 1520.75], [15, 99.859375, 1506.5], [15, 101.296875, 1507.75], [15, 102.640625, 1510.25], [14, 103.984375, 1530.0], [15, 105.21875, 1947.0], [15, 106.578125, 1947.25], [15, 107.890625, 1948.75], [15, 109.28125, 1952.25], [15, 110.6875, 1954.25], [15, 112.03125, 1961.0], [15, 113.40625, 1964.5], [15, 114.796875, 1970.5], [15, 116.21875, 1980.0], [15, 117.578125, 1999.75], [15, 118.953125, 2002.0], [15, 120.359375, 2020.25], [15, 121.734375, 2029.75], [15, 123.125, 1905.0], [15, 124.609375, 1701.25], [15, 126.0, 1691.25], [15, 127.359375, 1704.25], [15, 128.78125, 1718.25], [15, 130.125, 1737.25], [15, 131.515625, 1765.25], [15, 132.859375, 1780.75], [15, 134.265625, 1805.75], [15, 135.59375, 1848.75], [15, 137.015625, 1866.5], [15, 138.375, 1885.25], [15, 139.703125, 1916.0], [15, 141.109375, 1955.5], [15, 142.453125, 1986.75], [15, 143.859375, 2030.5], [15, 145.015625, 2058.25], [15, 146.375, 2099.0], [15, 147.703125, 2241.0], [15, 149.109375, 2207.0], [15, 150.484375, 2151.75], [15, 151.90625, 2101.5], [15, 153.296875, 2062.75], [15, 154.96875, 2015.25], [15, 156.375, 1970.0], [15, 157.734375, 1934.75], [15, 159.1875, 1884.5], [15, 160.578125, 1855.25], [15, 161.9375, 1822.75], [15, 163.375, 1801.75], [15, 164.71875, 1773.75], [15, 166.140625, 1746.0], [15, 167.515625, 1712.25], [15, 168.984375, 1700.5], [15, 170.359375, 1681.0], [15, 171.765625, 1657.0], [15, 173.109375, 1639.25], [15, 174.515625, 1630.25], [15, 175.921875, 1611.0], [15, 177.328125, 1595.25], [15, 178.6875, 1576.0], [15, 180.140625, 1569.5], [15, 181.46875, 1563.5], [15, 182.890625, 1550.5], [15, 184.28125, 1541.25], [15, 185.671875, 1539.5], [15, 187.078125, 1529.75], [15, 188.421875, 1524.0], [15, 189.8125, 1517.5], [15, 191.265625, 1515.25], [15, 192.578125, 1511.0], [15, 193.96875, 1509.75], [15, 195.40625, 1508.25], [15, 196.78125, 1509.25], [15, 198.140625, 1511.0], [15, 199.515625, 1513.25], [15, 200.90625, 1510.75], [15, 202.359375, 1521.25], [15, 203.734375, 1523.0], [15, 205.140625, 1526.0], [15, 206.484375, 1532.25], [15, 207.859375, 1536.75], [15, 209.265625, 1550.5], [15, 210.671875, 1562.5], [15, 212.03125, 1567.75], [15, 213.390625, 1582.75], [15, 214.796875, 1592.75], [15, 216.203125, 1606.0], [15, 217.515625, 1620.25], [15, 218.890625, 1634.0], [15, 220.328125, 1655.25], [15, 221.671875, 1680.5], [15, 223.046875, 1689.25], [15, 224.40625, 1713.5], [15, 225.84375, 1745.0], [15, 227.234375, 1761.75], [15, 228.640625, 1790.5], [15, 230.0, 1811.0], [15, 231.390625, 1845.75], [15, 232.734375, 1874.5], [15, 234.109375, 1905.0], [15, 235.484375, 1949.5], [15, 236.859375, 1993.5], [15, 238.234375, 2038.25], [15, 239.40625, 2075.25], [15, 240.78125, 2125.5], [15, 242.140625, 2180.0], [15, 243.53125, 2240.0], [15, 244.890625, 2301.5], [15, 246.296875, 2324.75], [15, 247.65625, 2309.5], [15, 249.0625, 2288.75], [15, 250.46875, 2248.5], [15, 251.828125, 2213.5], [15, 253.25, 2191.25], [15, 254.625, 2158.75], [15, 256.03125, 2125.0], [15, 257.40625, 2095.0], [15, 258.78125, 2070.5], [15, 260.421875, 2038.25], [15, 261.828125, 2012.0], [15, 263.265625, 1976.0], [15, 264.625, 1971.25], [15, 266.015625, 1940.5], [15, 267.4375, 1931.75], [15, 268.78125, 1925.75], [15, 270.203125, 1910.75], [15, 271.5625, 1901.25], [15, 273.03125, 1883.0], [15, 274.390625, 1878.0], [15, 275.6875, 1865.0], [15, 277.046875, 1853.75], [15, 278.453125, 1843.5], [15, 279.78125, 1835.0], [15, 281.21875, 1831.25], [15, 282.609375, 1811.25], [15, 283.96875, 1809.5], [15, 285.359375, 1824.25], [15, 286.703125, 1825.0], [15, 288.125, 1824.0], [15, 289.5, 1827.25], [15, 290.875, 1826.75], [15, 292.25, 1832.75], [15, 293.640625, 1835.75], [15, 295.03125, 1837.5], [15, 296.421875, 1852.0], [15, 297.796875, 1863.5], [15, 299.25, 1869.25], [15, 300.59375, 1875.5], [15, 301.953125, 1898.0], [15, 303.390625, 1905.25], [15, 304.734375, 1925.25], [15, 306.15625, 1947.25], [15, 307.5, 1955.75], [15, 308.90625, 1985.75], [15, 310.234375, 2000.25], [15, 311.625, 2024.25], [15, 313.0, 2060.0], [15, 314.421875, 2044.25], [15, 315.53125, 2093.25], [15, 316.921875, 2119.5], [15, 318.3125, 2168.75], [15, 319.65625, 2203.0], [15, 321.0625, 2239.0], [15, 322.421875, 2282.25], [15, 323.8125, 2319.0], [15, 325.1875, 2359.5], [15, 326.578125, 2399.25], [15, 327.921875, 2454.0], [15, 329.3125, 2507.5], [15, 330.703125, 2560.25], [15, 332.0625, 2632.75], [15, 333.4375, 2701.25], [15, 334.8125, 2775.0], [15, 336.375, 2157.75], [15, 337.71875, 2262.75], [15, 339.015625, 2447.25], [15, 340.375, 2677.25], [15, 344.25, 5708.75], [15, 345.640625, 5629.5], [15, 347.03125, 5592.0], [15, 348.40625, 5759.75], [15, 349.796875, 5592.0]]
def get_lidar_scan(heading):
    return [ [x[0],np.random.normal(x[1]+np.degrees(heading),1.0),np.random.normal(x[2],0.2)] for x in sim_lidar_scan ]


class CommsGyrus(ThreadedGyrus):
    def __init__(self,broker,simulation_mode=False):
        self.turn_speed=0.6
        self.fb_speed=0.6
        self.simulation_mode=simulation_mode
        if not simulation_mode:
            logging.info("Connecting to Gratbot comms")
            self.gratbot_comms = GratbotCommsMk2("10.0.0.4", 9999)
            #self.gratbot_comms.set(["ultrasonic_sensor","update_frequency"],4)
        else:
            self.sim_motors_on_until=0
            self.sim_motor_status=[0,0,0,0.1]
            self.sim_heading=1.31
            self.sim_stopped=False
        super().__init__(broker)

    def get_keys(self):
        return [ "clock_pulse","motor_command","sim" ]

    def get_name(self):
        return "CommsUpdateGyrus"

    def read_message(self,message):
        if "sim" in message:
            if message["sim"]=="stop":
                self.sim_stopped=True
            if message["sim"]=="go":
                self.sim_stopped=False

        if "clock_pulse" in message:
            if not self.simulation_mode:
                comms_message=self.gratbot_comms.update()
                my_keys=[]
                for key in comms_message:
                    if key != "timestamp":
                        my_keys.append(key)
                comms_message["timestamp"]=time.time() #in case its clock has skew
                self.broker.publish(comms_message,my_keys)
            else: #SIMULATION MODE
                if self.sim_stopped:
                    return
                if self.sim_motor_status[2]!=0:
                    gprint("simulation turning")
                    self.sim_heading+=np.random.normal(np.sign(self.sim_motor_status[2])*0.2,0.2)
                base_field=np.array([2.78,123.61,-58.58])
                dir_field=np.array([50*np.sin(self.sim_heading),50*np.cos(self.sim_heading),0])
                #sim_field=np.random.normal([-14.527915814089448, 126.6150248465361, -103.27389652148496],[2,2,2])
                #sim_field=np.random.normal(base_field+dir_field,[2,2,2])
                sim_field=np.random.normal(base_field+dir_field,[0,0,0])
                #self.broker.publish({"timestamp": time.time(),"magnetometer/b_field": [0,0,0], "lidar/lidar_scan": sim_lidar_scan,"drive/motors_active": [0,0,0,0.1]},["magnetometer/b_field","lidar/lidar_scan","drive/motors_active"])
                self.broker.publish({"timestamp": time.time(),"position_sensor/calibration": [2, 3, 0, 0], "drive/motors_active": [0, 0, 10.707296371459961], "position_sensor/gyro_stdev": [0.0013841090967215508, 0.002058175404067621, 0.0010687915251348867], "position_sensor/acceleration": [0.003, 0.018999999999999996, -0.255], "position_sensor/acceleration_stdev": [0.0045825756949558405, 0.005385164807134504, 0.010246950765959608], "position_sensor/b_field_inst": [33.75, -18.875, -32.5], "position_sensor/acceleration_inst": [0.0, 0.02, -0.27], "position_sensor/gyro": [0.0003272492347489369, -0.0013089969389957472, 0.0002181661564992912], "position_sensor/b_field_stdev": [0.171846588560844, 0.125, 0.9371874478992983], "position_sensor/b_field": [33.4875, -18.8125, -33.71875], "position_sensor/gyro_inst": [0.002181661564992912, -0.004363323129985824, -0.001090830782496456]},["position_sensor/gyro","drive/motors_active"])

                #self.broker.publish({"timestamp": time.time(),"magnetometer/b_field": sim_field.tolist(), "lidar/lidar_scan": get_lidar_scan(self.sim_heading),"drive/motors_active": self.sim_motor_status,"ultrasonic_sensor/last_measurement": {"stdev_distance": 0.0034996659736768487, "average_distance": 2.1871761480967202, "n_averages": 6, "timestamp": 1619901786.2459009}},["magnetometer/b_field","lidar/lidar_scan","drive/motors_active"])
                if time.time()>self.sim_motors_on_until:
                    self.sim_motor_status=[0,0,0,0.1]
        if "motor_command" in message and not self.simulation_mode:
            if "duration" in message["motor_command"]:
                tosend=[message["motor_command"]["lr_throttle"][0],message["motor_command"]["lr_throttle"][1],message["motor_command"]["duration"]]
            else:
                tosend=message["motor_command"]["lr_throttle"]
            self.gratbot_comms.set(["drive","go"],tosend)
        if "motor_command" in message and self.simulation_mode:
            ...
